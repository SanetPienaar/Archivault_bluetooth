<!DOCTYPE html>
<html lang="en">
<head>
    <title>Archivault - Curator Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <style>
        body { font-family: sans-serif; background: #0f172a; color: white; margin: 0; height: 100vh; overflow: hidden; }
        
        /* Screen Management */
        #selectionScreen { padding: 40px; text-align: center; }
        #dashboardScreen { display: none; height: 100vh; display: flex; flex-direction: column; }
        
        /* Trip Cards */
        .trip-card { background: #1e293b; padding: 20px; border-radius: 12px; margin: 10px auto; max-width: 400px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 1px solid #334155; }
        .trip-card:hover { border-color: #22d3ee; }
        .delete-btn { color: #ef4444; border: none; background: none; cursor: pointer; font-weight: bold; }
        
        /* Header */
        header { background: #1e293b; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #22d3ee; height: 50px; }
        
        /* Layout Containers */
        .viz-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        #map { flex: 3; width: 100%; background: #000; border-bottom: 1px solid #334155; }
        
        .chart-panel { flex: 2; background: #1e293b; padding: 10px; position: relative; display: flex; flex-direction: column; }
        .chart-controls { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9em; color: #94a3b8; }
        .chart-wrapper { flex-grow: 1; position: relative; width: 100%; }

        /* Stats Bar */
        .stats-panel { background: #0f172a; padding: 10px 20px; display: flex; gap: 20px; border-top: 1px solid #334155; height: 30px; align-items: center; }
        
        /* Inputs */
        select { background: #334155; color: white; border: none; padding: 5px; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="selectionScreen">
        <h1 style="color:#22d3ee;">Archivault Logistics</h1>
        <h3>Select a Trip to Monitor</h3>
        <div id="tripList">Loading trips...</div>
    </div>

    <div id="dashboardScreen">
        <header>
            <button onclick="location.reload()" style="background:#334155; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer;">‚Üê Back</button>
            <h2 id="activeTripTitle" style="margin:0; font-size:1.2em;">Trip Name</h2>
            <div>
                <span style="font-size:0.8em; color:#94a3b8;">ALERT THRESHOLD</span>
                <input type="range" id="safetySlider" min="0.5" max="5.0" step="0.1" value="1.5"> 
                <span id="limitDisp" style="color:#ef4444; font-weight:bold;">1.50G</span>
            </div>
        </header>
        
        <div class="viz-container">
            <div id="map"></div>

            <div class="chart-panel">
                <div class="chart-controls">
                    <span>Live Shock Data</span>
                    <select id="timeWindowSelector" onchange="updateTimeWindow()">
                        <option value="1">Last 1 Minute</option>
                        <option value="5" selected>Last 5 Minutes</option>
                        <option value="10">Last 10 Minutes</option>
                        <option value="0">Full History</option>
                    </select>
                </div>
                <div class="chart-wrapper">
                    <canvas id="shockChart"></canvas>
                </div>
            </div>
        </div>

        <div class="stats-panel">
            <div>Current Impact: <span id="curG" style="color:#22d3ee; font-weight:bold; font-size: 1.2em;">0.00G</span></div>
            <div style="margin-left:auto;">Logged Events: <span id="breadCount">0</span></div>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCLiWeNn7SVAs0VDpv8ST6xvplqGytnnIU",
            authDomain: "archivault-8d6ff.firebaseapp.com",
            databaseURL: "https://archivault-8d6ff-default-rtdb.firebaseio.com/",
            projectId: "archivault-8d6ff"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- GLOBAL VARIABLES ---
        let map, driverMarker, breadcrumbGroup;
        let chartInstance; 
        let shockDataArray = []; // Stores {x: timestamp, y: gValue}
        let activeTripListenerLoc = null;
        let activeTripListenerShock = null;

        // --- SCREEN 1: TRIP LIST ---
        db.ref('trips').on('value', (snapshot) => {
            const list = document.getElementById('tripList');
            list.innerHTML = "";
            snapshot.forEach((child) => {
                const div = document.createElement('div');
                div.className = "trip-card";
                div.innerHTML = `<span onclick="startMonitoring('${child.key}')">üöõ ${child.key}</span>
                                 <button class="delete-btn" onclick="deleteTrip('${child.key}')">‚úï</button>`;
                list.appendChild(div);
            });
        });

        function deleteTrip(name) {
            if(confirm("Delete trip data for " + name + "?")) db.ref('trips/' + name).remove();
        }

        // --- SCREEN 2: MONITORING ---
        function startMonitoring(tripName) {
            document.getElementById('selectionScreen').style.display = "none";
            document.getElementById('dashboardScreen').style.display = "flex";
            document.getElementById('activeTripTitle').innerText = tripName;

            // 1. INITIALIZE MAP
            if(map) { map.remove(); } // Reset map if exists
            map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
            breadcrumbGroup = L.layerGroup().addTo(map);
            driverMarker = L.marker([0,0]).addTo(map).bindPopup("Current Location");

            // 2. INITIALIZE CHART
            initChart();

            // 3. LISTEN FOR LOCATIONS (Map & Breadcrumbs)
            const locRef = db.ref(`trips/${tripName}/locations`);
            locRef.on('child_added', (snap) => {
                const data = snap.val();
                if(!data.lat || !data.lng) return;

                const pos = [data.lat, data.lng];
                
                // Update Driver
                driverMarker.setLatLng(pos);
                map.panTo(pos);

                // Add Breadcrumb
                const color = data.isViolation ? "#ef4444" : "#22d3ee";
                const size = data.isViolation ? 8 : 4;
                
                L.circleMarker(pos, {
                    radius: size,
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.8,
                    stroke: false
                }).addTo(breadcrumbGroup)
                  .bindPopup(`Time: ${new Date(data.t).toLocaleTimeString()}<br>Shock: ${data.maxG}G`);
                
                document.getElementById('breadCount').innerText = breadcrumbGroup.getLayers().length;
            });

            // 4. LISTEN FOR SHOCK DATA (Graph & Stats)
            const shockRef = db.ref(`trips/${tripName}/shocks`);
            
            // Clear previous data
            shockDataArray = [];
            
            shockRef.on('child_added', snap => {
                const val = snap.val();
                // Update Stats Text
                document.getElementById('curG').innerText = parseFloat(val.g).toFixed(2) + "G";
                
                // Update Chart Data
                const point = {
                    x: val.t, // Timestamp
                    y: parseFloat(val.g)
                };
                shockDataArray.push(point);
                
                // Refresh Chart
                updateChartData();
            });
        }

        // --- CHART LOGIC ---
        function initChart() {
            const ctx = document.getElementById('shockChart').getContext('2d');
            
            // Destroy old chart if exists to prevent memory leaks
            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Shock (G)',
                        data: shockDataArray,
                        borderColor: '#22d3ee',
                        backgroundColor: 'rgba(34, 211, 238, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0, // Hide points for cleaner line
                        pointHoverRadius: 4,
                        fill: true,
                        tension: 0.4 // Smooth curves
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false, // Disable animation for performance on real-time
                    interaction: {
                        mode: 'nearest',
                        intersect: false
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                displayFormats: { minute: 'HH:mm:ss' }
                            },
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' },
                            suggestedMax: 3 // Keep graph height reasonable
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Start a loop to update the "sliding window" even if no data comes in
            setInterval(() => {
                if(document.getElementById('dashboardScreen').style.display === 'flex') {
                    updateTimeWindow(); 
                }
            }, 1000);
        }

        function updateChartData() {
            if(!chartInstance) return;
            chartInstance.data.datasets[0].data = shockDataArray;
            updateTimeWindow(); // Ensure window is correct
            chartInstance.update('none'); // Update without animation
        }

        function updateTimeWindow() {
            if(!chartInstance) return;
            
            const minutes = parseInt(document.getElementById('timeWindowSelector').value);
            const now = Date.now();

            if (minutes === 0) {
                // Show All
                delete chartInstance.options.scales.x.min;
                delete chartInstance.options.scales.x.max;
            } else {
                // Sliding Window (Current Time - X minutes)
                chartInstance.options.scales.x.min = now - (minutes * 60 * 1000);
                chartInstance.options.scales.x.max = now;
            }
            chartInstance.update('none');
        }

        // --- SETTINGS ---
        const slider = document.getElementById('safetySlider');
        slider.oninput = function() {
            document.getElementById('limitDisp').innerText = parseFloat(this.value).toFixed(2) + "G";
            db.ref('safety_settings/max_g').set(this.value);
        };
    </script>
</body>
</html>
