<!DOCTYPE html>
<html lang="en">
<head>
    <title>Archivault - Curator Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: sans-serif; background: #0f172a; color: white; margin: 0; }
        #selectionScreen { padding: 40px; text-align: center; }
        #dashboardScreen { display: none; height: 100vh; display: flex; flex-direction: column; }
        .trip-card { background: #1e293b; padding: 20px; border-radius: 12px; margin: 10px auto; max-width: 400px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 1px solid #334155; }
        .trip-card:hover { border-color: #22d3ee; }
        .delete-btn { color: #ef4444; border: none; background: none; cursor: pointer; font-weight: bold; }
        
        header { background: #1e293b; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #22d3ee; }
        #map { flex-grow: 1; width: 100%; background: #000; }
        .stats-panel { background: #1e293b; padding: 15px; display: flex; gap: 20px; }
    </style>
</head>
<body>

    <div id="selectionScreen">
        <h1>Archivault Logistics</h1>
        <h3>Select a Trip to Monitor</h3>
        <div id="tripList">Loading trips...</div>
    </div>

    <div id="dashboardScreen">
        <header>
            <button onclick="location.reload()" style="background:#334155; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer;">‚Üê Back</button>
            <h2 id="activeTripTitle">Trip Name</h2>
            <div>Safety Limit: <input type="range" id="safetySlider" min="0.5" max="5.0" step="0.1" value="1.5"> <span id="limitDisp">1.50</span>G</div>
        </header>
        
        <div id="map"></div>

        <div class="stats-panel">
            <div>Current Speed/Shock: <span id="curG" style="color:#22d3ee; font-weight:bold;">0.00G</span></div>
            <div style="margin-left:auto;">Total Breadcrumbs: <span id="breadCount">0</span></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCLiWeNn7SVAs0VDpv8ST6xvplqGytnnIU",
            authDomain: "archivault-8d6ff.firebaseapp.com",
            databaseURL: "https://archivault-8d6ff-default-rtdb.firebaseio.com/",
            projectId: "archivault-8d6ff"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let map, driverMarker, breadcrumbGroup;

        // --- SCREEN 1 LOGIC ---
        db.ref('trips').on('value', (snapshot) => {
            const list = document.getElementById('tripList');
            list.innerHTML = "";
            snapshot.forEach((child) => {
                const div = document.createElement('div');
                div.className = "trip-card";
                div.innerHTML = `<span onclick="startMonitoring('${child.key}')">${child.key}</span>
                                 <button class="delete-btn" onclick="deleteTrip('${child.key}')">Delete</button>`;
                list.appendChild(div);
            });
        });

        function deleteTrip(name) {
            if(confirm("Delete trip: " + name + "?")) db.ref('trips/' + name).remove();
        }

        // --- SCREEN 2 LOGIC ---
        function startMonitoring(tripName) {
            document.getElementById('selectionScreen').style.display = "none";
            document.getElementById('dashboardScreen').style.display = "flex";
            document.getElementById('activeTripTitle').innerText = tripName;

            // Initialize Map
            map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            breadcrumbGroup = L.layerGroup().addTo(map);
            driverMarker = L.marker([0,0]).addTo(map).bindPopup("Driver Current Location");

            // Listen for Locations & Breadcrumbs
            db.ref(`trips/${tripName}/locations`).on('child_added', (snap) => {
                const data = snap.val();
                const pos = [data.lat, data.lng];
                
                // Update Driver Marker
                driverMarker.setLatLng(pos);
                map.panTo(pos);

                // Add Breadcrumb
                const color = data.isViolation ? "#ef4444" : "#22d3ee";
                const size = data.isViolation ? 8 : 4;
                
                L.circleMarker(pos, {
                    radius: size,
                    color: color,
                    fillOpacity: 0.8
                }).addTo(breadcrumbGroup)
                  .bindPopup(`Time: ${new Date(data.t).toLocaleTimeString()}<br>Peak Shock: ${data.maxG}G`);
                
                document.getElementById('breadCount').innerText = breadcrumbGroup.getLayers().length;
            });

            // Listen for Shock Data (Top Status)
            db.ref(`trips/${tripName}/shocks`).limitToLast(1).on('child_added', snap => {
                document.getElementById('curG').innerText = snap.val().g + "G";
            });
        }

        // Safety Slider Logic
        const slider = document.getElementById('safetySlider');
        slider.oninput = function() {
            document.getElementById('limitDisp').innerText = parseFloat(this.value).toFixed(2);
            db.ref('safety_settings/max_g').set(this.value);
        };
    </script>
</body>
</html>
