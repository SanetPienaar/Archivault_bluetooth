<!DOCTYPE html>
<html lang="en">
<head>
    <title>Archivault curator Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <style>
        body { font-family: sans-serif; background: #0f172a; color: white; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; background: #1e293b; padding: 15px; border-radius: 15px; border-bottom: 3px solid #22d3ee; }
        .controls { margin-top: 15px; background: #334155; padding: 10px; border-radius: 10px; display: flex; gap: 10px; align-items: center; }
        .chart-area { background: #1e293b; border-radius: 15px; margin-top: 20px; padding: 20px; height: 55vh; }
        select { padding: 8px; border-radius: 5px; background: #1e293b; color: white; border: 1px solid #22d3ee; }
        button { padding: 8px 15px; border-radius: 5px; cursor: pointer; border: none; font-weight: bold; }
        .btn-zoom { background: #22d3ee; color: #0f172a; }
        .btn-reset { background: #475569; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <h2 style="margin:0">Archivault Curator Monitor</h2>
        <div>Peak: <span id="cG" style="color:#22d3ee; font-size:1.2em;">0.00</span>G</div>
    </div>

    <div class="controls">
        <label>Select Trip:</label>
        <select id="tripPicker">
            <option value="">-- Choose a Trip --</option>
        </select>
        
        <div style="margin-left:auto; display:flex; gap:5px;">
            <button class="btn-zoom" onclick="chart.zoom(1.2)">Zoom In (+)</button>
            <button class="btn-zoom" onclick="chart.zoom(0.8)">Zoom Out (-)</button>
            <button class="btn-reset" onclick="chart.resetZoom()">Reset View</button>
        </div>
    </div>

    <div class="chart-area">
        <canvas id="tripChart"></canvas>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCLiWeNn7SVAs0VDpv8ST6xvplqGytnnIU",
            authDomain: "archivault-8d6ff.firebaseapp.com",
            databaseURL: "https://archivault-8d6ff-default-rtdb.firebaseio.com/",
            projectId: "archivault-8d6ff"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const ctx = document.getElementById('tripChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Shock (G)', data: [], borderColor: '#22d3ee', fill: true, backgroundColor: 'rgba(34,211,238,0.1)', stepped: true }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { zoom: { zoom: { wheel: { enabled: true }, mode: 'x' }, pan: { enabled: true, mode: 'x' } } }
            }
        });

        // 1. POPULATE THE PULL-DOWN MENU
        db.ref('trips').on('value', (snapshot) => {
            const picker = document.getElementById('tripPicker');
            const currentSelection = picker.value;
            picker.innerHTML = '<option value="">-- Choose a Trip --</option>';
            
            snapshot.forEach((child) => {
                const opt = document.createElement('option');
                opt.value = child.key;
                opt.innerText = child.key;
                picker.appendChild(opt);
            });
            picker.value = currentSelection;
        });

        // 2. SWITCH TRIPS WHEN SELECTED
        let currentListener = null;
        document.getElementById('tripPicker').onchange = function() {
            const tripID = this.value;
            if (!tripID) return;

            // Clear old data and listener
            if (currentListener) db.ref('trips').child(currentListener).off();
            chart.data.labels = [];
            chart.data.datasets[0].data = [];
            currentListener = tripID;

            // Start new listener for the selected trip
            db.ref('trips/' + tripID).on('child_added', (snap) => {
                const val = snap.val();
                chart.data.labels.push(new Date(val.t).toLocaleTimeString());
                chart.data.datasets[0].data.push(val.g);
                document.getElementById('cG').innerText = val.g;
                chart.update('none');
            });
        };
    </script>
</body>
</html>
