<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ArcheVault Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* DASHBOARD LAYOUT - NO SCROLLING */
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: #0f172a; 
            color: white; 
            margin: 0; 
            height: 100vh; 
            overflow: hidden; /* Prevents scrolling */
            display: flex;
            flex-direction: column;
        }

        /* WARNING OVERLAY */
        #warningOverlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #ef4444; color: white; z-index: 9999; 
            justify-content: center; align-items: center; flex-direction: column;
        }
        #warningOverlay h1 { font-size: 15vw; margin: 0; }
        #warningOverlay p { font-size: 8vw; }

        /* MAIN APP CONTAINER */
        .app-grid {
            flex: 1;
            display: grid;
            grid-template-rows: auto 1fr 1fr auto;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }

        /* WIDGET STYLES */
        .widget { 
            background: #1e293b; 
            border-radius: 16px; 
            padding: 10px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            text-align: center;
        }
        
        .header { grid-column: span 2; display: flex; gap: 10px; }
        input[type=text] { 
            flex: 1; padding: 12px; border-radius: 10px; border: none; 
            background: #334155; color: white; text-align: center; font-size: 1rem;
        }

        /* G-FORCE (Big) */
        .shock-panel { grid-column: span 1; }
        .val-large { font-size: 2.5rem; font-weight: bold; color: #22d3ee; }
        .label-small { color: #94a3b8; font-size: 0.8rem; text-transform: uppercase; }

        /* COMPASS (Big) */
        .compass-panel { grid-column: span 1; position: relative; }
        .compass-circle {
            width: 80px; height: 80px; border: 4px solid #475569; border-radius: 50%;
            position: relative; display: flex; justify-content: center; align-items: center;
            background: #0f172a;
        }
        .compass-arrow {
            width: 0; height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 40px solid #ef4444; /* North Pointer */
            position: absolute; top: 10px;
            transform-origin: bottom center;
            transition: transform 0.2s ease-out;
        }
        .compass-text { position: absolute; font-size: 0.7rem; font-weight: bold; color: #94a3b8; bottom: -20px; }

        /* TEMP & STATUS */
        .temp-panel { grid-column: span 2; flex-direction: row; justify-content: space-around; }
        .temp-val { font-size: 1.8rem; font-weight: bold; color: #fbbf24; }

        /* FOOTER BUTTON */
        .footer { grid-column: span 2; }
        button { 
            width: 100%; padding: 20px; border-radius: 16px; 
            background: #22d3ee; border: none; font-weight: 900; 
            color: #0f172a; font-size: 1.2rem; cursor: pointer;
            box-shadow: 0 4px 15px rgba(34, 211, 238, 0.3);
        }
        button:disabled { background: #475569; color: #94a3b8; }

    </style>
</head>
<body>

    <div id="warningOverlay">
        <h1>ðŸš¨</h1>
        <h1>SLOW DOWN</h1>
        <p id="violationVal">0.00G</p>
    </div>

    <div class="app-grid">
        <div class="header">
            <input type="text" id="tripName" placeholder="Trip Name (e.g., Box_4)">
        </div>

        <div class="widget shock-panel">
            <span class="label-small">Impact</span>
            <span id="liveVal" class="val-large">0.0G</span>
            <span id="thresholdDisplay" style="font-size: 0.7rem; color: #64748b;">Max: 1.50G</span>
        </div>

        <div class="widget compass-panel">
            <div class="compass-circle">
                <div id="compassNeedle" class="compass-arrow"></div>
            </div>
            <span id="compassText" class="compass-text">N</span>
        </div>

        <div class="widget temp-panel">
            <div>
                <span class="label-small" style="display:block">Temp</span>
                <span id="tempVal" class="temp-val">--Â°C</span>
            </div>
            <div style="text-align:right">
                <span class="label-small" style="display:block">Status</span>
                <span id="statusText" style="color:#4ade80; font-weight:bold;">Ready</span>
            </div>
        </div>

        <div class="footer">
            <button id="connectBtn">START MONITORING</button>
        </div>
    </div>

    <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCLiWeNn7SVAs0VDpv8ST6xvplqGytnnIU",
            authDomain: "archivault-8d6ff.firebaseapp.com",
            databaseURL: "https://archivault-8d6ff-default-rtdb.firebaseio.com/",
            projectId: "archivault-8d6ff",
            storageBucket: "archivault-8d6ff.firebasestorage.app",
            messagingSenderId: "162258741675",
            appId: "1:162258741675:web:35e26def41f72e65a38aee"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // UUIDs for Micro:bit Services
        const ACCEL_SERVICE = 'e95d0753-251d-470a-a062-fa1922dfa9a8';
        const ACCEL_DATA    = 'e95dca4b-251d-470a-a062-fa1922dfa9a8';
        
        const MAG_SERVICE   = 'e95df2d8-251d-470a-a062-fa1922dfa9a8';
        const MAG_BEARING   = 'e95d9715-251d-470a-a062-fa1922dfa9a8'; // Returns degrees (0-360)

        const TEMP_SERVICE  = 'e95d6100-251d-470a-a062-fa1922dfa9a8';
        const TEMP_DATA     = 'e95d9250-251d-470a-a062-fa1922dfa9a8';

        // State Variables
        let curatorLimit = 1.5;
        let lastLat = 0, lastLng = 0;
        let peakThisInterval = 0;
        let currentTemp = 0;
        let currentBearing = 0;
        let lastGUpload = Date.now();
        let lastGPSUpload = Date.now();
        let isBeeping = false;

        // --- 1. SETTINGS SYNC ---
        function syncThreshold() {
            db.ref('safety_settings/max_g').once('value').then(snap => {
                if(snap.exists()) {
                    curatorLimit = parseFloat(snap.val());
                    document.getElementById('thresholdDisplay').innerText = "Limit: " + curatorLimit.toFixed(2) + "G";
                }
            });
        }
        syncThreshold();
        setInterval(syncThreshold, 60000); // Check every minute

        // --- 2. ALERT SYSTEM ---
        function triggerBeep(val) {
            if (isBeeping) return;
            isBeeping = true;

            const overlay = document.getElementById('warningOverlay');
            document.getElementById('violationVal').innerText = val.toFixed(2) + "G";
            overlay.style.display = "flex";
            
            document.getElementById('beep').play().catch(() => {});

            setTimeout(() => {
                overlay.style.display = "none";
                isBeeping = false;
            }, 500);
        }

        // --- 3. GPS TRACKING ---
        navigator.geolocation.watchPosition(
            (pos) => { lastLat = pos.coords.latitude; lastLng = pos.coords.longitude; },
            (err) => console.log(err), 
            { enableHighAccuracy: true }
        );

        // --- 4. BLUETOOTH CONNECTION ---
        document.getElementById('connectBtn').addEventListener('click', async () => {
            const tripName = document.getElementById('tripName').value.trim().replace(/[^a-zA-Z0-9]/g, "_") || "Trip_" + Date.now();
            const btn = document.getElementById('connectBtn');
            
            try {
                btn.innerText = "CONNECTING...";
                
                // Request Device with ALL Services
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'BBC micro:bit' }],
                    optionalServices: [ACCEL_SERVICE, MAG_SERVICE, TEMP_SERVICE]
                });

                const server = await device.gatt.connect();
                document.getElementById('statusText').innerText = "Active";
                document.getElementById('statusText').style.color = "#22d3ee";
                btn.innerText = "RUNNING";
                btn.disabled = true;

                // --- A. ACCELEROMETER SETUP ---
                const accelService = await server.getPrimaryService(ACCEL_SERVICE);
                const accelChar = await accelService.getCharacteristic(ACCEL_DATA);
                await accelChar.startNotifications();
                accelChar.addEventListener('characteristicvaluechanged', handleAccel);

                // --- B. COMPASS SETUP ---
                try {
                    const magService = await server.getPrimaryService(MAG_SERVICE);
                    const magChar = await magService.getCharacteristic(MAG_BEARING);
                    await magChar.startNotifications();
                    magChar.addEventListener('characteristicvaluechanged', (e) => {
                        let bearing = e.target.value.getUint16(0, true);
                        currentBearing = bearing;
                        
                        // Update UI Needle Rotation
                        // Note: transform needs to counteract bearing to point North relative to phone, 
                        // or just show bearing. Here we rotate the needle to match the degree.
                        document.getElementById('compassNeedle').style.transform = `rotate(${bearing}deg)`;
                        
                        // Update Text (N/NE/E/SE...)
                        const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
                        const index = Math.round(((bearing %= 360) < 0 ? bearing + 360 : bearing) / 45) % 8;
                        document.getElementById('compassText').innerText = directions[index] + " " + bearing + "Â°";
                    });
                } catch(e) { console.log("Compass Service missing (Calibrate micro:bit?)"); }

                // --- C. TEMPERATURE SETUP ---
                try {
                    const tempService = await server.getPrimaryService(TEMP_SERVICE);
                    const tempChar = await tempService.getCharacteristic(TEMP_DATA);
                    await tempChar.startNotifications();
                    tempChar.addEventListener('characteristicvaluechanged', (e) => {
                        currentTemp = e.target.value.getInt8(0);
                        document.getElementById('tempVal').innerText = currentTemp + "Â°C";
                    });
                } catch(e) { console.log("Temp Service missing"); }

                // --- DATA HANDLER ---
                function handleAccel(event) {
                    let d = event.target.value;
                    let x = d.getInt16(0, true) / 1000;
                    let y = d.getInt16(2, true) / 1000;
                    let z = d.getInt16(4, true) / 1000;
                    let total = Math.sqrt(x*x + y*y + z*z);

                    document.getElementById('liveVal').innerText = total.toFixed(2) + "G";
                    if (total > peakThisInterval) peakThisInterval = total;

                    if (total > curatorLimit) triggerBeep(total);

                    let now = Date.now();
                    
                    // Upload Shocks (1s)
                    if (now - lastGUpload >= 1000) {
                        db.ref(`trips/${tripName}/shocks`).push({ g: total.toFixed(2), t: now });
                        lastGUpload = now;
                    }

                    // Upload GPS + Temp + Bearing (5s)
                    if (now - lastGPSUpload >= 5000) {
                        db.ref(`trips/${tripName}/locations`).push({
                            lat: lastLat, 
                            lng: lastLng, 
                            maxG: peakThisInterval.toFixed(2),
                            temp: currentTemp,    // Logged Temp
                            bearing: currentBearing, // Logged Direction
                            isViolation: peakThisInterval > curatorLimit,
                            t: now
                        });
                        lastGPSUpload = now;
                        peakThisInterval = 0; 
                    }
                }

            } catch (err) { 
                alert("Connect Error: " + err); 
                btn.innerText = "RETRY";
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>
