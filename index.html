<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArcheVault - Driver Guard</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background-color: #0f172a; color: white; margin: 0; padding: 20px; overflow: hidden; }
        .container { max-width: 500px; margin: auto; background: #1e293b; padding: 25px; border-radius: 24px; position: relative; z-index: 1; }
        .box { background: #334155; padding: 15px; border-radius: 15px; margin-bottom: 15px; }
        input[type=text] { width: 80%; padding: 12px; border-radius: 10px; border: none; margin-top: 10px; background: #475569; color: white; text-align: center; }
        button { padding: 15px; border-radius: 12px; background: #22d3ee; border: none; font-weight: bold; cursor: pointer; width: 100%; color: #0f172a; font-size: 1.1em; }
        
        /* FULL SCREEN OVERLAY */
        #warningOverlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100vw; 
            height: 100vh; 
            background: #ef4444; 
            color: white; 
            z-index: 9999; 
            justify-content: center; 
            align-items: center; 
            flex-direction: column;
        }
        #warningOverlay h1 { font-size: 4em; margin: 0; }
        #warningOverlay p { font-size: 2em; }
    </style>
</head>
<body>

    <div id="warningOverlay">
        <h1>ðŸš¨</h1>
        <h1>SLOW DOWN</h1>
        <p id="violationVal">0.00G</p>
    </div>

    <div class="container">
        <h1>ArcheVault</h1>
        <div id="status" style="color:#94a3b8; margin-bottom:10px;">Waiting for setup...</div>
        
        <div class="box">
            <input type="text" id="tripName" placeholder="Trip Name">
        </div>

        <div class="box">
            <small>LIVE G-FORCE</small>
            <span id="liveVal" style="font-size:3em; display:block; font-weight:bold;">0.00G</span>
            <small id="thresholdDisplay" style="color: #94a3b8;">Limit: 1.50G</small>
        </div>

        <button id="connectBtn">START TRANSPORT</button>
    </div>

    <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCLiWeNn7SVAs0VDpv8ST6xvplqGytnnIU",
            authDomain: "archivault-8d6ff.firebaseapp.com",
            databaseURL: "https://archivault-8d6ff-default-rtdb.firebaseio.com/",
            projectId: "archivault-8d6ff",
            storageBucket: "archivault-8d6ff.firebasestorage.app",
            messagingSenderId: "162258741675",
            appId: "1:162258741675:web:35e26def41f72e65a38aee"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let curatorLimit = 1.5;
        let lastLat = 0, lastLng = 0;
        let peakThisInterval = 0;
        let lastGUpload = Date.now();
        let lastGPSUpload = Date.now();
        let isBeeping = false;

        // Sync threshold from Firebase every 60 seconds
        function syncThreshold() {
            db.ref('safety_settings/max_g').once('value').then(snap => {
                if(snap.exists()) {
                    curatorLimit = parseFloat(snap.val());
                    document.getElementById('thresholdDisplay').innerText = "Limit: " + curatorLimit.toFixed(2) + "G";
                }
            });
        }
        syncThreshold();
        setInterval(syncThreshold, 60000);

        // Play beep and show full-screen red frame
        function triggerBeep(val) {
            if (isBeeping) return;
            isBeeping = true;

            const audio = document.getElementById('beep');
            const overlay = document.getElementById('warningOverlay');
            
            document.getElementById('violationVal').innerText = val.toFixed(2) + "G";
            overlay.style.display = "flex";
            audio.play().catch(() => {});

            // Close after 0.5 seconds
            setTimeout(() => {
                overlay.style.display = "none";
                isBeeping = false;
            }, 500);
        }

        navigator.geolocation.watchPosition((pos) => {
            lastLat = pos.coords.latitude;
            lastLng = pos.coords.longitude;
        }, null, { enableHighAccuracy: true });

        document.getElementById('connectBtn').addEventListener('click', async () => {
            const tripName = document.getElementById('tripName').value.trim() || "Trip_" + Date.now();
            
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'BBC micro:bit' }],
                    optionalServices: ['e95d0753-251d-470a-a062-fa1922dfa9a8']
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('e95d0753-251d-470a-a062-fa1922dfa9a8');
                const char = await service.getCharacteristic('e95dca4b-251d-470a-a062-fa1922dfa9a8');
                
                document.getElementById('status').innerText = "Active: " + tripName;
                char.startNotifications();
                
                char.addEventListener('characteristicvaluechanged', (e) => {
                    let d = e.target.value;
                    let total = Math.sqrt(Math.pow(d.getInt16(0,true)/1000,2)+Math.pow(d.getInt16(2,true)/1000,2)+Math.pow(d.getInt16(4,true)/1000,2));
                    
                    document.getElementById('liveVal').innerText = total.toFixed(2) + "G";
                    if (total > peakThisInterval) peakThisInterval = total;

                    if (total > curatorLimit) triggerBeep(total);

                    let now = Date.now();
                    if (now - lastGUpload >= 1000) {
                        db.ref(`trips/${tripName}/shocks`).push({ g: total.toFixed(2), t: now });
                        lastGUpload = now;
                    }
                    if (now - lastGPSUpload >= 5000) {
                        db.ref(`trips/${tripName}/locations`).push({
                            lat: lastLat, lng: lastLng, maxG: peakThisInterval.toFixed(2),
                            isViolation: peakThisInterval > curatorLimit, t: now
                        });
                        lastGPSUpload = now;
                        peakThisInterval = 0; 
                    }
                });
            } catch (err) { alert(err); }
        });
    </script>
</body>
</html>
